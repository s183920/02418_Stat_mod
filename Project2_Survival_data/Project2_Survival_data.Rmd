---
title: 'Project2: Survival data'
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<!-- # Packages -->

```{r Packages, include=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(GGally)
library(magrittr)
```


# Data

## Load
```{r Data load}
act_data <- read.delim("../Data/actg320.txt", header = T, sep = "\t")
log_data <-  read.delim("../Data/Logistic.txt", header = T, sep = "\t") %>% 
  bind_rows(data.frame(AZT = "Total", AIDS_yes = sum(.$AIDS_yes), n= sum(.$n)))

```

## Summaries

### Logistic data

```{r Summary log}
summary(log_data)
```

### ACT data

```{r Summary ACT}
summary(act_data)
```



## Plot



```{r Pair plots}
#pairplot_act  <- ggpairs(act_data)
#ggsave("Plots/pairplot_act.png", pairplot_act)
```

# Analysis of binomial data

## Binomial fit - all

We summarise the data into one group - total number of AIDS cases and total number of patients.
Afterwards we fit the binomial distribution to the full (total) dataset. The binomial distribution has the density:
$$p_{\theta}(k) = \left(\begin{array}[cc]2n\\ k\end{array}\right)\theta^k(1-\theta)^{n-k}$$
With $n$ being the total number of patients and $k$ the total number of patients with aids.
Hence we get the likelihood:
$$L(\theta) = \left(\begin{array}[cc]2n\\ k\end{array}\right)\theta^k(1-\theta)^{n-k}$$

MLE for $\theta$ is estimated numerically, buut: $MLE = \frac{k}{n}$
Confidence intervals are estimated using the likelihood interval method
$$CI: \left\{\theta, \frac{L(\theta)}{L(\hat{\theta)}> c \right\}$$
with $c = exp(-\frac{1}{2} \chi_{1,(1-\alpha)}^2) $ - with $\chi_1^2$ being $\chi^2$ distribution with 1 degree of freedom.

```{r Binomial fit all}
data <- as.numeric(log_data[3,2:3])
binomial <- function(data, theta){
    k <- data[1]
    n <- data[2]
    choose(n,k) * theta^k *(1-theta)^(n-k)
}

theta <- seq(0,1,0.001)
MLE <- data[1]/data[2]
c <- exp(-1/2*qchisq(1-0.05,1))

plot(theta, binomial(data, theta)/max(binomial(data, theta)), "l")
abline(c,0)
a <- theta[binomial(data,theta)/max(binomial(data,theta)) > c]
CI <- c(min(a), max(a))
cat("Maximum Likelihood estimate: ", MLE, "\n")
cat("Likelihood Confidence intervals: ", CI)

```
## Binomial fit seperately
Data is divided into 2 groups: a control group (without AZT) and a test group (with AZT).
A binomial distribution is fitted to each - as in previous question.



```{r }
AZT_yes <- as.numeric(log_data[1,2:3])
AZT_no <- as.numeric(log_data[2,2:3])

theta <- seq(0,1,0.00001)
par(mfrow=c(1,2))
alpha <- 0.05
c <- exp(-1/2*qchisq(1-alpha,1))
plot(theta, binomial(AZT_yes, theta)/max(binomial(AZT_yes, theta)), "l")
abline(c, 0)
plot(theta, binomial(AZT_no, theta)/max(binomial(AZT_no, theta)), "l")
abline(c, 0)

MLE_yes <- optimize(binomial, c(0,1), data = AZT_yes, maximum = TRUE)$maximum
MLE_no <-  optimize(binomial, c(0,1), data = AZT_no, maximum = TRUE)$maximum

a_yes <- theta[binomial(AZT_yes,theta)/max(binomial(AZT_yes,theta)) > c]
CI_yes <- c(min(a_yes), max(a_yes))

a_no <- theta[binomial(AZT_no,theta)/max(binomial(AZT_no,theta)) > c]
CI_no <- c(min(a_no), max(a_no))

CI_yes
CI_no
```
We notice a slight overlap in the 95 \% confidence intervals, indicating no difference (on a 5 \& significance level) in the succes probabilities ('succes' = you have AIDS).

## Estimate the parameters in the model (logistic model) with parameters $\beta_0$ and $\beta_1$
With a logistic model we get the succes probability for the control group $p_0$ and for the test group $p_1$:
$$p_{0}=\frac{e^{\beta_{0}}}{1+e^{\beta_{0}}}, \quad p_{1}=\frac{e^{\beta_{0}+\beta_{1}}}{1+e^{\beta_{0}+\beta_{1}}}$$
The parameter $b_1$ is the parameter describing the difference in succes probabilities ie. if $\beta_1 = 0$ no difference.
We can write the likelihood function for the logsitic distribution:
$$L(\beta_0, \beta_1) = \Pi_i p_i^{y_i}(1-p_i)^{1-y_i}$$
with $y_i$ denoting succes in category i. $i=0$ control group, $i=1$ test group.
The log likelihood for this is
$$logL(\beta_0, \beta_1) = \sum_i \left[(\beta_0 + \beta_1 \cdot group_i)y_i - log(1 + exp(\beta_0 + \beta_1 \cdot group_i)) \right]$$
```{r}
logL_partial <- function(b0, b1, data, AZT = TRUE){
    y = if (AZT) {data[1,2]} else {data[2,2]} %>% as.numeric()
    n = if (AZT) {data[1,3]} else {data[2,3]} %>% as.numeric()
    false = n-y
    
    y*((b0 + b1 * AZT) * 1 - log(1+exp(b0+b1*AZT))) + false*((b0 + b1 * AZT) * 0 - log(1+exp(b0+b1*AZT)))
}

logL <- function(theta, data){
     - (logL_partial(theta[1], theta[2],data, F) + logL_partial(theta[1],theta[2],data, T))
}


opt <- nlminb(c(0, 0), logL, lower = c(-Inf,-Inf), data = log_data)

p0 <- exp(opt$par[1])/(1+exp(opt$par[1]))
p1 <- exp(opt$par[1] + opt$par[2])/(1+exp(opt$par[1] + opt$par[2]))





logL_b1 <- function(theta, b1, data){
      -(logL_partial(theta[1], b1,data, F) + logL_partial(theta[1],b1,data, T))
}
profile_b1 <- function(b1, data){
  opt <- nlminb(c(0), logL_b1, lower = c(-Inf), data = log_data, b1 = b1)
  # optimize(logL)
  b0 <- opt$par
  -logL_b1(c(b0),b1,data)
}


b1 <- seq(-5,5,0.0001)
alpha <- 0.05
c <- exp(-1/2*qchisq(1-alpha,1))
plot(b1, exp(profile_b1(b1,log_data)) /exp(max(profile_b1(b1,log_data))), 'l')
abline(c, 0)

a_yes <- b1[exp(profile_b1(b1,log_data)) /exp(max(profile_b1(b1,log_data))) > c]
CI_yes <- c(min(a_yes), max(a_yes))
CI_yes

cat("The maximum likelihood estimates of p0 and p1 are: p0 = ", p0, " p1 = ", p1)
cat("The maximum profile likelihood estimate of b1 is:  ", )
```

