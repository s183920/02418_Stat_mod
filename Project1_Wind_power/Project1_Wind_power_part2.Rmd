---
title: "Project1: Wind power energy"
output: 
  html_document:
  toc: true
  toc_float: true
  # toc_collapsed: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Packages

```{r include=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(GGally)
library(magrittr)
library(MASS)
```


## Load
```{r}
wind_data <- read.delim("../Data/tuno.txt", header = T, sep = " ")
summary(wind_data)
wind_data$pow.obs.norm <- (wind_data$pow.obs)/5000

#normalized_pow.obs <- scale(wind_data$pow.obs)
#colMeans(normalized_pow.obs)
#apply(normalized_pow.obs, 2, sd)
#var(wind_data$pow.obs)
#var(wind_data$ws30)
#var(wind_data$wd30)

```


#Regression 

## Initial model
```{r}
model1 <- glm(pow.obs.norm ~ ws30 + I(ws30^2), data = wind_data, family = Gamma(link = "logit"))
model2 <- glm(pow.obs.norm ~ ws30 + I(ws30^2) + wd30, data = wind_data, family = Gamma(link = "logit"))
AIC(model2) #-216.3865
summary(model1)
anova(model1,model2, test = "Chisq")
qqnorm(model1$residuals)
qqline(model1$residuals)


#Deviance test 
anova(model1,model2,test="Chisq")

model1$null.deviance



```

```{r}
plot(wind_data$ws30, wind_data$pow.obs.norm, col="red", cex=0.2, pch=20, main="Power observations as a function of wind speed 30", xlab="Windspeed (m/s)", ylab="Average daily wind power production (kW)")
points(wind_data$ws30, wind_data$pow.obs, col="blue", cex=0.2, pch=20)
#legend("topleft", legend=c("Energy Possible (Uncurtailed)", "Energy Sentout (Curtailed)"), col=c("red", "green"), pch=20)

```
## Konverter wd30 til punkter på en enhedscirkel
```{r}
#Von mises benyt: install.packages("RDocumentation")
library("RDocumentation")
library("movMF")

pts_on_unit_circle <- cbind(cos(wind_data$wd30 * pi / 180), 
                            sin(wind_data$wd30 * pi / 180))
d <- movMF(pts_on_unit_circle, 1)
mu <- atan2(d$theta[,2], d$theta[,1])
kappa <- sqrt(rowSums(d$theta^2))

movMF(pts_on_unit_circle, 3.6, control = list())


```



## Models without data tranmsformation
```{r}
#series expnsion
model2.1 <- glm(pow.obs.norm ~ ws30 + I(ws30^2), data=wind_data)
summary(model2.1)
model2.2 <- glm(pow.obs.norm ~ ws30 + I(pts_on_unit_circle), data=wind_data)
summary(model2.2)
model2.3 <- glm(pow.obs.norm ~ ws30 + I(ws30^2) + I(wd30^3), family=Gamma, data=wind_data) #Denne benyttes!!! -301.6694


AIC(model2.1)
AIC(model2.2)
AIC(model2.3)
```

```{r}
#Gamma
model3 <- glm(pow.obs.norm ~ ws30 + I(ws30^2) + I(wd30^3), family=Gamma(log),  data=wind_data)
summary(model3)
AIC(model3) #-333.9629 med poac og  -332.7959 med wd30


anova(model3,model2.1,test="Chisq")

```

```{r}
#Beta
library(betareg)
model4 <- betareg(pow.obs.norm ~ ws30 + I(ws30^2) + I(pts_on_unit_circle^3), data=wind_data)
summary(model4)
AIC(model4) #-480.2231   med poauc: -484.3731


```



## Predict 

```{r}
library(ggplot2)
predict(model3, type="response")




plot(wind_data$ws30, wind_data$pow.obs.norm, pch = 16, xlab = , ylab = "Pow.obs.norm")
lines(predict(model3, type="response"))
```
















## Models using transformation 1, from project 1:
Optimer lambda således at residualerne fra modellen best fitter en normalfordeling. 

```{r, warning=FALSE}
trans1 <- function(lambda,y){
    y.l <- 1/lambda*log((y^lambda)/(1-y^lambda))
    return(y.l)}

## profile likelihood for lambda
lp.lambda1 <- function(lambda,y){
    mod <- lm(trans1(lambda,y)~wind_data$ws30+I(wind_data$ws30^2))
    length(y)/2*log(summary(mod)$sigma^2) - sum(log(abs(1/(y*(1 - y^lambda)))))
    }

plot(seq(0.01,1,0.01), sapply(seq(0.01,1,0.01), lp.lambda1, y=wind_data$pow.obs.norm))

lp.lambda1(1/1, wind_data$pow.obs.norm)
(opt.lambda.trans1=optimize(lp.lambda1,c(0,1),y=wind_data$pow.obs.norm))

```

```{r}
model5=glm(trans1(opt.lambda.trans1$minimum,wind_data$pow.obs.norm) ~ ws30+I(wind_data$ws30^2),family=gaussian,  data=wind_data)
summary(model5)
AIC(model5) #1583.717 hvad er meningen med, at denne bliver så høj?
```

```{r}
qqnorm(model5$residuals)
qqline(model5$residuals)

```



## Models using transformation 2 from project 1:
```{r, warning=FALSE}
trans2 <- function(lambda,y){
    y.l <- 2*log((y^lambda)/(1-y)^(1-lambda))
    return(y.l)}

## profile likelihood for lambda
lp.lambda2 <- function(lambda,y){
    n <- length(y)
    y.l <- trans2(lambda ,y)
    sigmasq <- 1/n * sum((y.l-mean(y.l))^2)
    -n/2 * log(sigmasq) + sum(log(abs(((4*lambda - 2)*y - 2*lambda)/(y*(-1 + y)))))}
    
(opt.lambda.trans2=optimize(lp.lambda2,c(0.000001,1),y=wind_data$pow.obs.norm, maximum=TRUE))

```
```{r}
model6=glm(trans2(opt.lambda.trans2$maximum,wind_data$pow.obs.norm)~ ws30 , family=gaussian,  data=wind_data)
summary(model6)
AIC(model6) #hvorfor bliver denne så stor??? 860.2163
```
```{r}
qqnorm(model6$residuals)
qqline(model6$residuals)
```


## Models using Boxcox transformation: 
```{r}
## box-cox transformation
bc.trans <- function(lambda,y){
    y.l <- (y^lambda-1)/lambda
    
    if(lambda==0){y.l <- log(y)}
    return(y.l)}

## profile likelihood for lambda
lp.lambda <- function(lambda,y){
    n <- length(y)
    y.l <- bc.trans(lambda ,y)
    sigmasq <- 1/n * sum((y.l-mean(y.l))^2)
    -n/2 * log(sigmasq) + (lambda-1)*sum(log(y))}


(opt.lambda.boxcox=optimize(lp.lambda,c(-2,2),y=wind_data$pow.obs.norm,maximum=TRUE))


```

```{r}
model7 <- glm(bc.trans(opt.lambda.boxcox$maximum,wind_data$pow.obs.norm)~ ws30,family=gaussian,  data=wind_data)
summary(model7)
AIC(model7) #408.4183
```

```{r}
qqnorm(model7$residuals) #de er virkelig flot normalfordelte!!!
qqline(model7$residuals)
```
















#Gamle ting herunder 



```{r}
#Von mises benyt: install.packages("RDocumentation")
library("RDocumentation")
library("movMF")

pts_on_unit_circle <- cbind(cos(wind_data$wd30 * pi / 180), 
                            sin(wind_data$wd30 * pi / 180))
d <- movMF(pts_on_unit_circle, 1)
mu <- atan2(d$theta[,2], d$theta[,1])
kappa <- sqrt(rowSums(d$theta^2))

movMF(pts_on_unit_circle, 3.6, control = list())


pvonmises(pts_on_unit_circle, mu, kappa, from=NULL, tol = 1e-020)



glm(exp(3.6*cos(pts_on_unit_circle-mean(pts_on_unit_circle)))/2*pi*I(3.6), data=wind_data)
```


```{r}
scatter.smooth(x=wind_data$ws30, y=wind_data$pow.obs, main="Pow.obs ~ wind speed") #scatterplot
```
```{r} 
library(locfit)
#Fiting a polynomial function
empirical.mod<-locfit(pow.obs.norm ~ ws30, data=wind_data, family="gamma")
summary(empirical.mod)
```

```{r}
plot(model5)
points(y=wind_data$pow.obs.norm, x=wind_data$ws30, cex=0.1, pch=20, col="red")


var(wind_data$ws30,wind_data$pow.obs.norm)
fitted <- fitted(empirical.mod)


library(MASS)
test <- gamma.shape(model3, verbose = TRUE)

fit2 <- rxGlm(
  pow.obs.norm ~ ws30 + pts_on_unit_circle,
  data = wind_data,
  family = Gamma(link = "inverse"))
summary(fit2)



x     <- data.frame(wind_data$pow.obs.norm, wind_data$ws30)
model <- glm(pow.obs.norm ~ ws30, data= wind_data)
plot(wind_data$ws30, wind_data$pow.obs.norm, #xlab="Temperature",ylab="Probability of Response"
     ) 
curve(predict(model, add=TRUE, col="red")

```
```{r}
library(fitdistrplus)
descdist(wind_data$pow.obs, boot=1000)
descdist(wind_data$ws30, boot=1000) 
```
```{r}
weibull.fit<-fitdist(wind_data$pow.obs, distr="weibull")
summary(weibull.fit)
```

